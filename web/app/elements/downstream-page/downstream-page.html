<!--
// Copyright 2015 Google Inc. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
-->

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../message-type-chooser/message-type-chooser.html">
<link rel="import" href="../protocol-chooser/protocol-chooser.html">
<link rel="import" href="../recipients-chooser/recipients-chooser.html">
<link rel="import" href="../request-previewer/request-previewer.html">


<dom-module id="downstream-page">

  <style>
    :host {
      display: block;
    }

    paper-material {
      @apply(--layout-vertical);
      border-radius: 2px;
      height: 100%;
      padding: 30px;
      margin: 16px auto;
      background: white;
    }

    #parameters {
      display: block;
    }

    #parameters section, #preview section {
      padding: 20px;
    }

    #parameters section h4, #preview section h4 {
      margin-bottom: 30px;
    }

    #parameters .notif_line, #parameters .line {
      width: 47%;
      display: inline-block;
    }

    #parameters .notif_line:nth-child(odd) {
      margin-left: 10px;
    }

    #parameters .notif_line paper-input, #parameters .notif_line paper-textarea,
    #parameters .line paper-input, #parameters .line paper-textarea {
      width: 70%;
      margin-left: 10px;
      display: inline-block;
    }

    #parameters .line {
      margin-bottom: 20px;
    }

    #parameters .line span {
      margin-left: 24px;
    }

    #parameters .priority {
      margin-top: 20px;
    }

    #parameters #priority {
      width: 40%;
    }

    #preview paper-button {
      width: 250px;
      background-color: var(--default-primary-color);
      color: #fff;
    }

    #preview paper-button[disabled] {
      color: var(--disabled-text-color) !important;
      background: var(--paper-fab-disabled-background) !important;
    }

  </style>
  <template>
     <h2>Send Downstream Message</h2>

      <paper-material elevation="2">
        <h3>Step 1: Type of Message</h3>
        <message-type-chooser></message-type-chooser>
      </paper-material>

      <paper-material elevation="2">
        <h3>Step 2: Select Protocol</h3>
        <protocol-chooser id="protocolChooser" disable-http="{{disableHttp}}" disable-xmpp="{{disableXmpp}}"></protocol-chooser>
      </paper-material>

      <paper-material elevation="2">
        <h3>Step 3: Select Targets</h3>
        <recipients-chooser id="recipientsChooser" limit="{{regIdLimit_}}" registration-ids-length$="{{registrationIds.length}}"></recipients-chooser>
      </paper-material>

      <paper-material elevation="2" id="parameters">
        <h3>Step 4: Set Options</h3>

        <section>
          <h4>Notification Payload</h4>

          <!-- Get form settings -->
          <iron-ajax auto
                     url="/settings.json"
                     handleAs="json"
                     last-response="{{settings}}"
                     method='GET'>
          </iron-ajax>

          <template is="dom-repeat" items="{{settings.notificationFields_}}" as="field">
            <div class="notif_line">
              <template is="dom-if" if="{{field.android}}">
                <iron-icon icon="icons:android"></iron-icon>
              </template>
              <template is="dom-if" if="{{!field.android}}">
                <iron-icon icon="icons:d"></iron-icon>
              </template>
              <template is="dom-if" if="{{field.ios}}">
                <iron-icon src="/images/ios.svg"></iron-icon>
              </template>
              <template is="dom-if" if="{{!field.ios}}">
                <iron-icon icon="icons:d"></iron-icon>
              </template>
              <template is="dom-if" if="{{!field.textarea}}">
                <paper-input id="{{field.id}}" label="{{field.label}}"></paper-input>
              </template>
              <template is="dom-if" if="{{field.textarea}}">
                <paper-textarea id="{{field.id}}" label="{{field.label}}"></paper-textarea>
              </template>
              <paper-tooltip margin-top="-5">{{field.tooltip}}</paper-tooltip>
            </div>
          </template>
        </section>

        <section>
          <h4>Data Payload</h4>
          <p><a href="https://developers.google.com/cloud-messaging/server-ref#send-downstream">Learn more about it</a></p>
          <paper-textarea id="data" label="JSON"></paper-textarea>
        </section>

        <section>
          <h4>Other Options</h4>

          <div class="line">
            <paper-toggle-button id="delivery_receipt_requested" disabled="{{httpSelected}}"></paper-toggle-button>
            <span>Delivery Receipt Requested</span>
            <paper-tooltip margin-top="0">This parameter lets the app server request confirmation of message delivery.</paper-tooltip>
          </div>
          <template is="dom-repeat" items="{{settings.optionsFields_}}" as="field">
            <div class="line">
              <template is="dom-if" if="{{!field.input}}">
                <paper-toggle-button id="{{field.id}}"></paper-toggle-button>
                <span>{{field.label}}</span>
              </template>
              <template is="dom-if" if="{{field.input}}">
                <paper-input label="{{field.label}}" id="{{field.id}}"></paper-input>
              </template>
              <paper-tooltip margin-top="0">{{field.tooltip}}</paper-tooltip>
            </div>
          </template>

          <div class="line">
            <paper-input id="restricted_package_name" label="Restricted Package Name" disabled="{{xmppSelected}}"></paper-input>
            <paper-tooltip for="restricted_package_name" margin-top="0">The package name of the application where the registration tokens must match in order to receive the message.</paper-tooltip>
          </div>

          <div class="line">
            <paper-input id="message_id" label="Message ID" disabled="{{httpSelected}}" value="{{messageId}}" bind-value="{{messageId}}" style="width: 60%;"></paper-input>
            <paper-icon-button icon="icons:autorenew" style="width: 10%;" on-click="newMessageId_" disabled="{{httpSelected}}"></paper-icon-button>
            <paper-tooltip for="message_id" margin-top="0">This parameter uniquely identifies a message in an XMPP connection.</paper-tooltip>
          </div>

          <div class="priority">
            <div>Priority:</div><br>
            <paper-slider id="priority" pin snaps max="10" step="1" value="1"></paper-slider>
            <paper-tooltip margin-top="0">Sets the priority of the message.</paper-tooltip>
          </div>

        </section>
      </paper-material>

      <paper-material elevation="2" id="preview">
        <h3>Request Preview</h3>
        <request-previewer id="requestPreviewer" http-selected="{{httpSelected}}" xmpp-selected="{{xmppSelected}}"></request-previewer>

        <!-- Send the message -->
        <iron-ajax id="sendMessage"
                   url="[[settings.main.sendMessageEndpoint]]"
                   body="{{messageBody}}"
                   content-type="application/json"
                   handle-as="json"
                   on-response="messageSentHandler"
                   method="POST"
                   verbose>
        </iron-ajax>

        <paper-button raised class="primary" id="sendBtn" on-click="send_">
          <iron-icon icon="check"></iron-icon>
          Send Message
        </paper-button>
      </paper-material>

      <paper-toast id="toast" text="" visible="false"></paper-toast>
  </template>

  <script>
    (function () {
      Polymer({
        is: 'downstream-page',


        properties: {

          // This list of selected registration IDs
          registrationIds: {
            type: Array,
            value: function() {
              return [];
            }
          },

          // The message ID for an XMPP message
          messageId: {
            type: String,
            value: ''
          },

          // List of custom registration IDs, topic or notification group
          // For topic or notification group, length === 1
          customIds: {
            type: Array,
            value: function() {
              return [];
            }
          },

          // The type of message user has decided to send
          selectedType: {
            type: String,
            value: ''
          },

          toast: {
            text: String,
            visible: Boolean,
            value: function() {
              return { text: '', visible: false };
            }
          },

          // The protocol that is selected right now
          selectedProtocol: {
            type: String,
            value: ''
          },

          // True if the selected protocol is XMPP
          xmppSelected: {
            type: Boolean,
            computed: 'isProtocol_(selectedProtocol, "xmpp")'
          },

          // True if the selected protocol is HTTP
          httpSelected: {
            type: Boolean,
            computed: 'isProtocol_(selectedProtocol, "http")'
          },

          // Should HTTP be disabled?
          disableHttp: {
            type: Boolean,
            value: false
          },

          // Should XMPP be disabled?
          disableXmpp: {
            type: Boolean,
            value: false
          },

        },


        listeners: {
          'message-type-changed': 'messageTypeChangeHandler',
          'protocol-changed': 'protocolChangeHandler',
          'reg-id-changed': 'registrationIdChangeHandler',
          'custom-ids': 'customListHandler',
          'show-toast': 'showToast_'
        },


        // TODO(karangoel): Remove debugging logs
        log_: function(msg) {
          utils.log('downstream-page', msg);
        },


        /********************************************
         * EVENT HANDLERS
         ********************************************/

        /**
         * Handles the selection of the downstream message type.
         */
        messageTypeChangeHandler: function(e) {
          var selectedType = e.detail.choice;

          this.log_("Selected " + selectedType);

          this.$.protocolChooser.reset();
          this.$.recipientsChooser.deselectAllRegIds_();
          this.$.recipientsChooser.emptyCustomList_();

          this.setState_(selectedType);
        },

        /**
         * Handles the selection of the downstream message protocol.
         */
        protocolChangeHandler: function(e) {
          this.selectedProtocol = e.detail.choice;
          this.log_("Selected " + this.selectedProtocol);
          this.$.requestPreviewer.update();
        },


        /**
         * Handles the selection of registration ids.
         */
        registrationIdChangeHandler: function(e) {
          var action = e.detail.action;
          var regId = e.detail.regId;

          if (action === 'remove') {
            this.splice('registrationIds',
                this.registrationIds.indexOf(regId), 1);
          } else if (action === 'add') {
            this.push('registrationIds', regId);
          }
          this.log_(this.registrationIds);
        },


        /**
         * Handles input in the custom reg ID input field.
         */
        customListHandler: function(e) {
          this.customIds = e.detail.ids;
          this.log_(this.customIds);
        },


        /**
         * Handls the response from message sending call.
         */
        messageSentHandler: function(e) {
          var status = e.detail.status;
          if (status === 200) {
            this.showToast_('Message sent!');
          } else if (status === 404) {
            this.showToast_('Message sending failed. Is your server running?');
          } else {
            this.showToast_('Message sending failed.');
          }
          this.$.sendBtn.disabled = false;
        },


        /********************************************
         * PRIVATE FUNCTIONS
         ********************************************/

        /**
         * Returns true iff selectedProtocol is the same as the desiredProtocol.
         */
        isProtocol_: function(selectedProtocol, desiredProtocol) {
          return selectedProtocol === desiredProtocol;
        },


        /**
         * Generate and populate the message ID field with a random one
         */
        newMessageId_: function() {
          // The message ID is not guaranteed to be random.
          // Ideally, there should be a database of all used IDs to make sure
          // we don't use and already-used ID.
          this.messageId = Math.random().toString(36).substr(2, 20);
        },


        /**
         * Sets the state of the application based on the passed message type.
         */
        setState_: function(selectedType) {
          this.registrationIds = [];
          this.selectedType = selectedType;

          switch (selectedType) {
            case 'unicast':
              this.disableXmpp = false;
              this.regIdLimit_ = 1;
              this.$.recipientsChooser.enableAllRegIds_();
              this.setCustomListLabel_('Or, paste one registration ID');
              break;
            case 'multicast':
              this.disableXmpp = true;
              this.regIdLimit_ = -1;
              this.$.recipientsChooser.enableAllRegIds_();
              this.setCustomListLabel_('Paste more registration IDs');
              break;
            case 'pubsub':
              this.disableXmpp = false;
              this.regIdLimit_ = 0;
              this.$.recipientsChooser.disableAllRegIds_();
              this.setCustomListLabel_('Paste a topic. eg. /topic/myTopic');
              break;
            case 'notification_group':
              this.disableXmpp = false;
              this.regIdLimit_ = 0;
              this.$.recipientsChooser.disableAllRegIds_();
              this.setCustomListLabel_('Paste a notification group key');
              break;
          }
        },


        /**
         * Sets the label of the textarea in recipients card.
         */
        setCustomListLabel_: function(text) {
          this.$.recipientsChooser.setCustomListLabel_(text);
        },


        /**
         * Show a new toast with the passed text.
         */
        showToast_: function(text) {
          if (text.type === 'show-toast') {
            text = text.detail;
          }
          this.$.toast.text = text;
          this.$.toast.show();
        },


        /**
         * Builds, validates and returns the notification payload.
         * Returns `null` if validation failed.
         */
        getAndValidateNotification_: function() {
          var notification = {
            title: this.$$('#notif_title').value,
            body: this.$$('#notif_body').value,
            icon: this.$$('#notif_icon').value,
            sound: this.$$('#notif_sound').value,
            badge: this.$$('#notif_badge').value,
            tag: this.$$('#notif_tag').value,
            color: this.$$('#notif_color').value,
            click_action: this.$$('#notif_click_action').value,
            body_loc_key: this.$$('#notif_body_loc_key').value,
            title_loc_key: this.$$('#notif_title_loc_key').value,
            title_loc_args: this.$$('#notif_title_loc_args').value,
            body_loc_args: this.$$('#notif_body_loc_args').value
          };

          // Validate the syntax of JSON
          try {
            if (notification.body_loc_args) { JSON.parse(notification.body_loc_args); }
          } catch (err) {
            this.showToast_('Make sure Notification Body Loc Args is valid JSON');
            return null;
          }
          try {
            if (notification.title_loc_args) { JSON.parse(notification.title_loc_args); }
          } catch (err) {
            this.showToast_('Make sure Notification Title Loc Args is valid JSON');
            return null;
          }

          return notification;
        },


        /**
         * Builds, validates and returns the options.
         * Returns `null` if validation failed.
         */
        getAndValidateOptions_: function() {
          var options = {
            delivery_receipt_requested: this.$.delivery_receipt_requested.checked,
            dry_run: this.$$('#dry_run').checked,
            priority: this.$.priority.value,
            delay_while_idle: this.$$('#delay_while_idle').checked,
            content_available: this.$$('#content_available').checked,
            time_to_live: +this.$$('#time_to_live').value,
            collapse_key: this.$$('#collapse_key').value,
            restricted_package_name: this.$.restricted_package_name.value,
            message_id: this.$.message_id.value
          };

          // Clean up the fields according to the selected protocol
          if (this.selectedProtocol === 'http') {
            options.delivery_receipt_requested = false;
            options.message_id = '';
          }
          if (this.selectedProtocol === 'xmpp') {
            options.restricted_package_name = '';
          }

          // Make sure all required fields are present
          if (this.selectedProtocol === 'xmpp' && options.message_id === '') {
            this.showToast_('XMPP messages must have a message ID.');
            return null;
          }

          // Validate the range of time to live
          if (isNaN(options.time_to_live) || options.time_to_live > 2419200 || options.time_to_live < 0) {
            this.showToast_('Time to live should be smaller than 2,419,200 (4 weeks)');
            return null;
          }

          return options;
        },


        /**
         * Validates the selections and recipients by message type.
         * Returns `false` if validation failed, `true` otherwise.
         */
        validateByMessageType: function(customIds, selectedIds) {
          // Validate unicast message
          if (this.selectedType === 'unicast') {
            if (customIds.length + selectedIds.length !== 1) {
              this.showToast_('You can only send message to one recipient at a time.');
              return false;
            }
          }
          // Validate topic for pubsub messages
          if (this.selectedType === 'pubsub') {
            if (customIds.length !== 1) {
              this.showToast_('You can only send message to one topic at a time.');
              return false;
            }
            if (!customIds[0].startsWith('/topic/')) {
              this.showToast_('Your topic is not correct. Make sure it\'s of the format "/topic/<mytopic>"');
              return false;
            }
          }
          // Validate notification group
          if (this.selectedType === 'notification_group') {
            if (customIds.length !== 1) {
              this.showToast_('You can only send message to one notification group at a time.');
              return false;
            }
          }

          return true;
        },


        /**
         * Send a message
         */
        send_: function() {
          var notification = this.getAndValidateNotification_();
          if (!notification) return;

          var options = this.getAndValidateOptions_();
          if (!options) return;

          var dataPayload = this.$.data.value;
          var selectedIds = this.$.recipientsChooser.getSelectedIds();
          var customIds = this.customIds;

          // Make sure all required fields are present
          if (selectedIds.length === 0 && customIds.length === 0) {
            this.showToast_('Select at least one recipient.');
            return;
          }
          if (!this.validateByMessageType(this.customIds, selectedIds)) return;

          // Validate JSON
          try {
            if (dataPayload) { JSON.parse(dataPayload); }
          } catch (err) {
            this.showToast_('Make sure the data payload is valid JSON');
            return;
          }

          this.messageBody = {
            message: {
              notification: notification
            },
            protocol: this.selectedProtocol
          };
          // Merge options in top level of message JSON body
          for (var attrname in options) {
            this.messageBody[attrname] = options[attrname];
          }

          if (dataPayload && Object.keys(dataPayload) > 0) {
            this.messageBody.message.data = dataPayload;
          }

          console.log(this.messageBody.message);
          if (this.selectedType === 'unicast') {
            var allTargets = selectedIds.concat(customIds);
            this.messageBody.message.to = allTargets[0];
          } else if (this.selectedType === 'pubsub' || this.selectedType === 'notification_group') {
            this.messageBody.message.to = customIds[0];
          } else {
            var registrationIds = selectedIds;
            registrationIds.push.apply(registrationIds, customIds);
            this.messageBody.message.registration_ids = registrationIds
          }
          console.log(this.messageBody.message);

          this.$.sendBtn.disabled = true;

          this.messageBody = JSON.stringify(this.messageBody);
          this.$.sendMessage.generateRequest();

          this.showToast_('Sending message ID: ' + options.message_id);
        },


        /********************************************
         * LIFECYCLE FUNCTIONS
         ********************************************/


        attached: function() {
          // How many total IDs can the user select?
          // -1 = multicast
          this.regIdLimit_ = 1;

          this.newMessageId_();
        }
      });
    })();
  </script>

</dom-module>
