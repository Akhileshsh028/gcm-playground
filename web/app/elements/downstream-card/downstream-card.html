<dom-module id="downstream-card">

  <style>
    :host {
      display: block;
    }

    paper-material {
      @apply(--layout-vertical);
      border-radius: 2px;
      height: 100%;
      padding: 30px;
      margin: 16px auto;
      background: white;
    }

    #parameters {
      display: block;
    }

    #parameters section, #preview section {
      padding: 20px;
    }

    #parameters section h4, #preview section h4 {
      margin-bottom: 30px;
    }

    #parameters .notif_line {
      width: 49%;
      display: inline-block;
    }

    #parameters .notif_line:nth-child(odd) {
      margin-left: 10px;
    }

    #parameters .notif_line paper-input, #parameters .notif_line paper-textarea {
      width: 70%;
      margin-left: 10px;
      display: inline-block;
    }

    #parameters paper-input, #parameters paper-textarea {
      width: 45%;
      margin-left: 0;
      margin-right: 10px;
      display: inline-block;
    }

    #parameters .line {
      margin-bottom: 40px;
    }

    #parameters .line span {
      margin-left: 24px;
    }

    #parameters .priority {
      margin-top: 20px;
    }

    #parameters #priority {
      width: 40%;
    }

  </style>
  <template>
     <h2>Send Downstream Message</h2>

      <paper-material elevation="2">
        <h3>Step 1: Type of Message</h3>
        <message-type-chooser></message-type-chooser>
      </paper-material>

      <paper-material elevation="2">
        <h3>Step 2: Select Protocol</h3>
        <protocol-chooser disable-http$="{{disableHttp}}" disable-xmpp$="{{disableXmpp}}"></protocol-chooser>
      </paper-material>

      <paper-material elevation="2">
        <h3>Step 3: Select Targets</h3>
        <recipients-chooser limit$="{{regIdLimit}}" registration-ids-length$="{{registrationIds.length}}"></recipients-chooser>
      </paper-material>

      <paper-material elevation="2" id="parameters">
        <h3>Step 4: Set Options</h3>

        <section>
          <h4>Notification Payload</h4>

          <div class="notif_line">
            <iron-icon icon="icons:android"></iron-icon><iron-icon src="/images/ios.svg"></iron-icon><paper-input label="Title"></paper-input>
          </div>

          <div class="notif_line">
            <iron-icon icon="icons:android"></iron-icon><iron-icon src="/images/ios.svg"></iron-icon><paper-input label="Body"></paper-input>
          </div>

          <div class="notif_line">
            <iron-icon icon="icons:android"></iron-icon><iron-icon icon="icons:d"></iron-icon><paper-input label="Icon"></paper-input>
          </div>

          <div class="notif_line">
            <iron-icon icon="icons:android"></iron-icon><iron-icon src="/images/ios.svg"></iron-icon><paper-input label="Sound"></paper-input>
          </div>

          <div class="notif_line">
            <iron-icon icon="icons:d"></iron-icon><iron-icon src="/images/ios.svg"></iron-icon><paper-input label="Badge"></paper-input>
          </div>

          <div class="notif_line">
            <iron-icon icon="icons:android"></iron-icon><iron-icon icon="icons:d"></iron-icon><paper-input label="Tag"></paper-input>
          </div>

          <div class="notif_line">
            <iron-icon icon="icons:android"></iron-icon><iron-icon icon="icons:d"></iron-icon><paper-input label="Color"></paper-input>
          </div>

          <div class="notif_line">
            <iron-icon icon="icons:android"></iron-icon><iron-icon src="/images/ios.svg"></iron-icon><paper-input label="Click Action"></paper-input>
          </div>

          <div class="notif_line">
            <iron-icon icon="icons:d"></iron-icon><iron-icon src="/images/ios.svg"></iron-icon><paper-input label="Body Loc Key"></paper-input>
          </div>

          <div class="notif_line">
            <iron-icon icon="icons:d"></iron-icon><iron-icon src="/images/ios.svg"></iron-icon><paper-textarea label="Body Loc Args (JSON)"></paper-textarea>
          </div>

          <div class="notif_line">
            <iron-icon icon="icons:d"></iron-icon><iron-icon src="/images/ios.svg"></iron-icon><paper-input label="Title Loc Key"></paper-input>
          </div>

          <div class="notif_line">
            <iron-icon icon="icons:d"></iron-icon><iron-icon src="/images/ios.svg"></iron-icon><paper-textarea label="Title Loc Args (JSON)"></paper-textarea>
          </div>
        </section>

        <section>
          <h4>Data Payload</h4>
          <paper-textarea label="JSON"></paper-textarea>
        </section>

        <section>
          <h4>Other Options</h4>

          <div class="line">
            <paper-toggle-button></paper-toggle-button>
            <span>Dry Run</span>
          </div>
          <div class="line">
            <paper-toggle-button id="delivery_receipt_requested" disabled="{{httpSelected}}"></paper-toggle-button>
            <span>Delivery Receipt Requested</span>
          </div>
          <div class="line">
            <paper-toggle-button></paper-toggle-button>
            <span>Delay While Idle</span>
          </div>

          <paper-input label="Time to Live"></paper-input>
          <paper-input id="collapse_key" label="Collapse Key"></paper-input>
          <paper-input id="restricted_package_name" label="Restricted Package Name" disabled="{{xmppSelected}}"></paper-input>
          <paper-textarea label="Content Available (JSON)"></paper-textarea>

          <div class="priority">
            <div>Priority:</div><br>
            <paper-slider id="priority" pin snaps max="10" step="1" value="1"></paper-slider>
          </div>

        </section>
      </paper-material>

      <paper-material elevation="2" id="preview">
        <h3>Request Preview</h3>

        <iron-collapse id="httpPreview">
          <paper-item>Request URL: <code>https://gcm-http.googleapis.com/gcm/send</code></paper-item>
          <section>
            <h4>Request Headers</h4>
            <paper-item>Content-Type: application/json</paper-item>
            <paper-item>Authorization: key=YOUR_API_KEY</paper-item>
          </section>

          <section>
            <h4>Request Body</h4>
            <paper-textarea label="" value='{ "collapse_key": "score_update",
  "time_to_live": 108,
  "delay_while_idle": true,
  "data": {
    "score": "4x8",
    "time": "15:16.2342"
  },
  "to" : "APA91bHun4MxP5egoKMwt2KZFBaFUH-1RYqx..."
}'></paper-textarea>
          </section>
        </iron-collapse>

        <iron-collapse id="xmppPreview">
          <paper-item>Request URL: https://gcm-http.googleapis.com/gcm/send</paper-item>
          <section>
            <h4>XMPP stanza</h4>
            <paper-textarea label="Request Body" value='<message id="">
  <gcm xmlns="google:mobile:data">
  {
      "to":"REGISTRATION_ID",  // "to" replaces "registration_ids"
     "notification": {
        "title": "Portugal vs. Denmark”,
        "text”: "5 to 1”
      },
      "time_to_live":"600"
}

  }
  </gcm>
</message>'></paper-textarea>
          </section>
        </iron-collapse>

      </paper-material>

      <paper-toast id="toast" text="" visible="false"></paper-toast>
  </template>

  <script>
    (function () {
      Polymer({
        is: 'downstream-card',


        properties: {

          // This list of selected registration IDs
          registrationIds: {
            type: Array,
            notify: true,
            value: function() {
              return [];
            }
          },

          // List of custom registration IDs, topic or notification group
          // For topic or notification group, length === 1
          customIds: {
            type: Array,
            notify: true,
            value: function() {
              return [];
            }
          },

          toast: {
            text: String,
            visible: Boolean,
            value: function() {
              return { text: '', visible: false };
            }
          },

          // The protocol that is selected right now
          selectedProtocol: {
            type: String,
            notify: true,
            value: 'unicast'
          },

          // True iff the selected protocol is XMPP
          xmppSelected: {
            type: Boolean,
            computed: 'isProtocol_(selectedProtocol, "xmpp")'
          },

          // True iff the selected protocol is HTTP
          httpSelected: {
            type: Boolean,
            computed: 'isProtocol_(selectedProtocol, "http")'
          },

          // Should HTTP be disabled?
          disableHttp: {
            type: Boolean,
            value: false
          },

          // Should XMPP be disabled?
          disableXmpp: {
            type: Boolean,
            value: false
          },

        },

        _log: function(msg) {
          log('downstream-card', msg);
        },


        /********************************************
         * EVENT HANDLERS
         ********************************************/

        /**
         * Handles the selection of the downstream message type.
         */
        messageTypeChangeHandler: function(e) {
          var selectedType = e.detail.choice;

          this._log("Selected " + selectedType);

          this.$$('protocol-chooser').reset();
          this.$$('recipients-chooser').deselectAllRegIds_();
          this.$$('recipients-chooser').emptyCustomList_();

          this.setState_(selectedType);
        },

        /**
         * Handles the selection of the downstream message protocol.
         */
        protocolChangeHandler: function(e) {
          this.selectedProtocol = e.detail.choice;
          this._log("Selected " + this.selectedProtocol);

          if (this.selectedProtocol === 'http') {
            this.$.httpPreview.setAttribute('opened', 'true');
            if (this.$.xmppPreview.attributes.opened) {
              this.$.xmppPreview.attributes.removeNamedItem('opened');
            }
          } else {
            this.$.xmppPreview.setAttribute('opened', 'true');
            if (this.$.httpPreview.attributes.opened) {
              this.$.httpPreview.attributes.removeNamedItem('opened');
            }
          }
        },


        /**
         * Handles the selection of registration ids.
         */
        registrationIdChangeHandler: function(e) {
          var action = e.detail.action;
          var regId = e.detail.regId;

          if (action === 'remove') {
            this.splice('registrationIds',
                this.registrationIds.indexOf(regId), 1);
          } else if (action === 'add') {
            this.push('registrationIds', regId);
          }
          this._log(this.registrationIds);
        },


        /**
         * Handles input in the custom reg ID input field.
         */
        customListHandler: function(e) {
          this.customIds = e.detail.ids;
          this._log(this.customIds);
        },


        /********************************************
         * PRIVATE FUNCTIONS
         ********************************************/

        /**
         * Returns true iff selectedProtocol is the same as the desiredProtocol.
         */
        isProtocol_: function(selectedProtocol, desiredProtocol) {
          return selectedProtocol === desiredProtocol;
        },


        /**
         * Sets the state of the application based on the passed message type.
         */
        setState_: function(selectedType) {
          this.registrationIds = [];

          switch (selectedType) {
            case 'unicast':
              this.disableXmpp = false;
              this.regIdLimit = 1;
              this.$$('recipients-chooser').enableAllRegIds_();
              this.setCustomListLabel_('Or, paste one registration ID');
              break;
            case 'multicast':
              this.disableXmpp = true;
              this.regIdLimit = -1;
              this.$$('recipients-chooser').enableAllRegIds_();
              this.setCustomListLabel_('Paste more registration IDs');
              break;
            case 'pubsub':
              this.disableXmpp = false;
              this.regIdLimit = 0;
              this.$$('recipients-chooser').disableAllRegIds_();
              this.setCustomListLabel_('Paste a topic. eg. /topic/myTopic');
              break;
            case 'notification_group':
              this.disableXmpp = false;
              this.regIdLimit = 0;
              this.$$('recipients-chooser').disableAllRegIds_();
              this.setCustomListLabel_('Paste a notification group key');
              break;
          }
        },


        /**
         * Sets the label of the textarea in recipients card.
         */
        setCustomListLabel_: function(text) {
          this.$$('recipients-chooser').setCustomListLabel_(text);
        },


        /**
         * Show a new toast with the passed text.
         */
        showToast_: function(text) {
          if (text.type === 'show-toast') {
            text = text.detail;
          }
          this.$.toast.setAttribute('text', text);
          document.querySelector('#toast').show();
        },


        /********************************************
         * LIFECYCLE FUNCTIONS
         ********************************************/


        ready: function() {
          // How many total IDs can the user select?
          // -1 = multicast
          this.regIdLimit = 1;

          // Event listeners
          this.addEventListener('message-type-changed', this.messageTypeChangeHandler);
          this.addEventListener('protocol-changed', this.protocolChangeHandler);
          this.addEventListener('reg-id-changed', this.registrationIdChangeHandler);
          this.addEventListener('custom-ids', this.customListHandler);
          this.addEventListener('show-toast', this.showToast_);
        }
      });
    })();
  </script>

</dom-module>
